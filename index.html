<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>工艺处理甩干登记</title>
    
    <!-- 缓存控制meta标签 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- PWA配置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2575fc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="甩干登记">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="msapplication-TileColor" content="#2575fc">
    <meta name="msapplication-TileImage" content="icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 15px 0;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #2575fc;
            border-bottom: 3px solid #2575fc;
            background-color: #f0f7ff;
        }
        
        .form-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #2575fc;
            outline: none;
            box-shadow: 0 0 0 2px rgba(37, 117, 252, 0.2);
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        
        .success {
            background-color: #e7f7ef;
            color: #0a8f5e;
            border: 1px solid #a8e6bf;
        }
        
        .error {
            background-color: #fde8e8;
            color: #c53030;
            border: 1px solid #fbb6b6;
        }
        
        .records-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .records-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }
        
        .record-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .lot-info {
            font-weight: 500;
        }
        
        .status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-in {
            background-color: #e7f7ef;
            color: #0a8f5e;
        }
        
        .status-out {
            background-color: #e8f4fd;
            color: #1e6fba;
        }
        
        .install-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            margin-bottom: 10px;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 5px;
            }
            
            .form-container, .records-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>工艺处理甩干登记</h1>
            <p>PWA版本 - 可安装到手机</p>
        </header>
        
        <div class="nav-tabs">
            <div class="tab active" id="in-tab">进站录入</div>
            <div class="tab" id="out-tab">出站录入</div>
        </div>
        
        <div id="in-form" class="form-container">
            <h2>进站信息录入</h2>
            <div class="form-group">
                <label for="in-lot">Lot</label>
                <input type="text" id="in-lot" placeholder="请输入Lot编号">
            </div>
            <div class="form-group">
                <label for="in-model">型号</label>
                <input type="text" id="in-model" placeholder="请输入型号">
            </div>
            <div class="form-group">
                <label for="in-tooling-box">工装料盒</label>
                <input type="text" id="in-tooling-box" placeholder="请输入工装料盒编号">
            </div>
            <div class="form-group">
                <label for="in-middle-box">中段料盒</label>
                <input type="text" id="in-middle-box" placeholder="请输入中段料盒编号">
            </div>
            <div class="form-group">
                <label for="in-quantity">条数</label>
                <input type="number" id="in-quantity" placeholder="请输入条数">
            </div>
            <button id="in-submit">提交进站信息</button>
            <div id="in-message" class="message"></div>
        </div>
        
        <div id="out-form" class="form-container" style="display: none;">
            <h2>出站信息录入</h2>
            <div class="form-group">
                <label for="out-lot">Lot</label>
                <input type="text" id="out-lot" placeholder="请输入Lot编号">
            </div>
            <div class="form-group">
                <label for="out-model">型号</label>
                <input type="text" id="out-model" placeholder="请输入型号">
            </div>
            <div class="form-group">
                <label for="out-tooling-box">工装料盒</label>
                <input type="text" id="out-tooling-box" placeholder="请输入工装料盒编号">
            </div>
            <div class="form-group">
                <label for="out-middle-box">中段料盒</label>
                <input type="text" id="out-middle-box" placeholder="请输入中段料盒编号">
            </div>
            <div class="form-group">
                <label for="out-quantity">条数</label>
                <input type="number" id="out-quantity" placeholder="请输入条数">
            </div>
            <button id="out-submit">提交出站信息</button>
            <div id="out-message" class="message"></div>
        </div>
        
        <div class="records-container">
            <div class="records-title">最近记录</div>
            <div id="records-list">
                <!-- 记录将动态添加到这里 -->
            </div>
        </div>
    </div>

    <script>
        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // 内联Service Worker代码
                const swCode = `
// 定义缓存名称和版本
const CACHE_NAME = 'material-management-v2.0';

// 需要缓存的资源列表
const urlsToCache = [
  './',
  './material-management.html',
  './manifest.json'
];

// 安装事件 - 缓存资源
self.addEventListener('install', event => {
  console.log('Service Worker 安装中...');
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => {
        console.log('缓存资源:', urlsToCache);
        return cache.addAll(urlsToCache);
      })
      .then(() => {
        console.log('所有资源已缓存');
        return self.skipWaiting();
      })
  );
});

// 激活事件 - 清理旧缓存
self.addEventListener('activate', event => {
  console.log('Service Worker 激活中...');
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName !== CACHE_NAME) {
            console.log('删除旧缓存:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    }).then(() => {
      console.log('Service Worker 已激活');
      return self.clients.claim();
    })
  );
});

// 拦截请求 - 使用缓存或网络
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        // 如果缓存中有，返回缓存内容
        if (response) {
          return response;
        }
        
        // 否则从网络获取
        return fetch(event.request).then(response => {
          // 检查是否收到有效响应
          if (!response || response.status !== 200 || response.type !== 'basic') {
            return response;
          }
          
          // 克隆响应（因为响应是流，只能使用一次）
          const responseToCache = response.clone();
          
          // 将新资源添加到缓存
          caches.open(CACHE_NAME)
            .then(cache => {
              cache.put(event.request, responseToCache);
            });
            
          return response;
        });
      })
      .catch(() => {
        // 网络和缓存都失败时的处理
        console.log('网络请求失败，使用缓存');
      })
  );
});
                `;
                
                // 创建Blob URL并注册Service Worker
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swURL)
                  .then(function(registration) {
                    console.log('Service Worker 注册成功: ', registration.scope);
                  })
                  .catch(function(error) {
                    console.log('Service Worker 注册失败: ', error);
                  });
            });
        }

        // 初始化数据存储
        let records = JSON.parse(localStorage.getItem('materialRecords')) || [];
        
        // DOM元素
        const inTab = document.getElementById('in-tab');
        const outTab = document.getElementById('out-tab');
        const inForm = document.getElementById('in-form');
        const outForm = document.getElementById('out-form');
        const inSubmit = document.getElementById('in-submit');
        const outSubmit = document.getElementById('out-submit');
        const inMessage = document.getElementById('in-message');
        const outMessage = document.getElementById('out-message');
        const recordsList = document.getElementById('records-list');
        
        // 切换选项卡
        inTab.addEventListener('click', () => {
            inTab.classList.add('active');
            outTab.classList.remove('active');
            inForm.style.display = 'block';
            outForm.style.display = 'none';
        });
        
        outTab.addEventListener('click', () => {
            outTab.classList.add('active');
            inTab.classList.remove('active');
            outForm.style.display = 'block';
            inForm.style.display = 'none';
        });
        
        // 提交进站信息
        inSubmit.addEventListener('click', () => {
            const lot = document.getElementById('in-lot').value;
            const model = document.getElementById('in-model').value;
            const toolingBox = document.getElementById('in-tooling-box').value;
            const middleBox = document.getElementById('in-middle-box').value;
            const quantity = document.getElementById('in-quantity').value;
            
            // 表单验证
            if (!lot || !model || !toolingBox || !middleBox || !quantity) {
                showMessage(inMessage, '请填写所有字段', 'error');
                return;
            }
            
            // 检查Lot是否已存在
            const existingRecord = records.find(record => record.lot === lot && record.status === 'in');
            if (existingRecord) {
                showMessage(inMessage, '该Lot已存在进站记录', 'error');
                return;
            }
            
            // 添加记录
            const record = {
                id: Date.now(),
                lot,
                model,
                toolingBox,
                middleBox,
                quantity,
                status: 'in',
                timestamp: new Date().toLocaleString()
            };
            
            records.push(record);
            saveRecords();
            
            // 清空表单
            document.getElementById('in-lot').value = '';
            document.getElementById('in-model').value = '';
            document.getElementById('in-tooling-box').value = '';
            document.getElementById('in-middle-box').value = '';
            document.getElementById('in-quantity').value = '';
            
            showMessage(inMessage, '进站信息录入成功', 'success');
            updateRecordsList();
        });
        
        // 提交出站信息
        outSubmit.addEventListener('click', () => {
            const lot = document.getElementById('out-lot').value;
            const model = document.getElementById('out-model').value;
            const toolingBox = document.getElementById('out-tooling-box').value;
            const middleBox = document.getElementById('out-middle-box').value;
            const quantity = document.getElementById('out-quantity').value;
            
            // 表单验证
            if (!lot || !model || !toolingBox || !middleBox || !quantity) {
                showMessage(outMessage, '请填写所有字段', 'error');
                return;
            }
            
            // 查找对应的进站记录
            const inRecord = records.find(record => 
                record.lot === lot && 
                record.status === 'in'
            );
            
            if (!inRecord) {
                showMessage(outMessage, '未找到对应的进站记录', 'error');
                return;
            }
            
            // 验证信息是否一致
            if (inRecord.model !== model || 
                inRecord.toolingBox !== toolingBox || 
                inRecord.middleBox !== middleBox || 
                inRecord.quantity !== quantity) {
                showMessage(outMessage, '出站信息与进站信息不一致', 'error');
                return;
            }
            
            // 更新记录状态
            inRecord.status = 'out';
            inRecord.outTimestamp = new Date().toLocaleString();
            
            saveRecords();
            
            // 清空表单
            document.getElementById('out-lot').value = '';
            document.getElementById('out-model').value = '';
            document.getElementById('out-tooling-box').value = '';
            document.getElementById('out-middle-box').value = '';
            document.getElementById('out-quantity').value = '';
            
            showMessage(outMessage, '出站信息验证成功', 'success');
            updateRecordsList();
        });
        
        // 显示消息
        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }
        
        // 保存记录到本地存储
        function saveRecords() {
            localStorage.setItem('materialRecords', JSON.stringify(records));
        }
        
        // 更新记录列表
        function updateRecordsList() {
            recordsList.innerHTML = '';
            
            // 只显示最近的10条记录
            const recentRecords = records.slice(-10).reverse();
            
            if (recentRecords.length === 0) {
                recordsList.innerHTML = '<div class="record-item">暂无记录</div>';
                return;
            }
            
            recentRecords.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'record-item';
                
                const statusClass = record.status === 'in' ? 'status-in' : 'status-out';
                const statusText = record.status === 'in' ? '进站' : '出站';
                
                recordElement.innerHTML = `
                    <div>
                        <div class="lot-info">${record.lot} - ${record.model}</div>
                        <div>${record.toolingBox} / ${record.middleBox}</div>
                        <div>${record.quantity}条 - ${record.timestamp}</div>
                    </div>
                    <div class="status ${statusClass}">${statusText}</div>
                `;
                
                recordsList.appendChild(recordElement);
            });
        }
        
        // 初始化
        updateRecordsList();
    </script>
</body>
</html>